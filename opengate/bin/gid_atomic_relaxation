#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import opengate as gate
import click
import numpy as np
import matplotlib.pyplot as plt
import pandas
from pathlib import Path

CONTEXT_SETTINGS = dict(help_option_names=["-h", "--help"])


@click.command(context_settings=CONTEXT_SETTINGS)
@click.argument("rad_name", nargs=-1)
@click.option(
    "--store_data/--no-store_data",
    is_flag=True,
    default=False,
    help="Store data in the opengate folder",
)
@click.option(
    "--store_all",
    is_flag=True,
    default=False,
    help="Store all main nuclide data in the opengate folder",
)
@click.option("--verbose/--no-verbose", is_flag=True, default=False, help="Print data")
@click.option("--plot/--no-plot", is_flag=True, default=True, help="Plot data")
@click.option(
    "--web/--no-web",
    is_flag=True,
    default=False,
    help="Get data from IAEA web site (local if False)",
)
def go(rad_name, store_all, store_data, plot, verbose, web):
    """
    Helper command to display or store fluorescence atomic relaxation for some radionuclides.

    Data are retrieved from https://www-nds.iaea.org/relnsd/vcharthtml/VChartHTML.html

    By default, data are stored in text files in the folder: opengate/opengate/data/atomic_relaxation

    """

    if store_all:
        gate.store_main_ion_gamma_atomic_relaxation_nds_iaea()
        exit()

    if len(rad_name) != 1:
        gate.fatal(f"Please, provide one radionuclide, such as bi213")

    # get nuclide, a, z
    nuclide = gate.get_nuclide(rad_name[0])
    name = nuclide.nuclide[: nuclide.nuclide.index("-")]

    # retrieve the data from the iaea website
    if web:
        df = gate.get_ion_gamma_atomic_relaxation_nds_iaea(nuclide.A, name)
        ene, weights = gate.get_ion_gamma_atomic_relaxation_ene_weights(df)
        # print
        if verbose:
            pandas.set_option("display.max_rows", None)
            pandas.set_option("display.max_columns", None)
            print(df)
        # store ?
        if store_data:
            gate.store_ion_gamma_atomic_relaxation_nds_iaea(nuclide.nuclide, df)

    else:
        try:
            ene, weights = gate.load_ion_gamma_atomic_relaxation_nds_iaea(
                nuclide.nuclide
            )
        except Exception as exception:
            gate.fatal(
                f"Cannot get this radionuclide {nuclide.nuclide}, try with --web option ? "
                f"\n{exception}"
            )

    keV = gate.g4_units("keV")
    if verbose:
        i = 0
        for e, w in zip(ene, weights):
            print(f"{i} Energy {e / keV:.3f} keV     {w * 100:.3f} %")
            i += 1

    # plot
    if plot:
        f, ax = plt.subplots(1, 1, figsize=(15, 5))
        ax.bar(ene / keV, height=weights * 100, width=0.1, label=f"{nuclide.nuclide}")
        ax.set_xlabel("Energy in keV")
        ax.set_ylabel("Intensity in %")
        ax.legend()
        plt.show()


# --------------------------------------------------------------------------
if __name__ == "__main__":
    go()
