#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import click
import json
import itk
import opengate.contrib.phantoms.nemaiec as gate_iec
from opengate.managers import Simulation
from opengate.engines import SimulationEngine
from opengate.logger import log, LOG_NONE
from opengate.utility import g4_units, print_dic
from opengate.image import (
    create_image_with_volume_extent,
    get_info_from_image,
    voxelize_volume,
)

CONTEXT_SETTINGS = dict(help_option_names=["-h", "--help"])


@click.command(context_settings=CONTEXT_SETTINGS)
@click.option("--spacing", "-s", default=4, help="Spacing in mm")
@click.option("--output", "-o", required=True, help="output filename (.mhd)")
def go(output, spacing):
    # create the simulation
    sim = Simulation()

    # shhhht !
    log.setLevel(LOG_NONE)

    # world
    m = g4_units.m
    sim.world.size = [1 * m, 1 * m, 1 * m]

    # add a iec phantom
    # FIXME add param
    iec = gate_iec.add_iec_phantom(
        sim, sphere_starting_angle=False, toggle_sphere_order=False
    )

    # create an empty image with the size (extent) of the volume
    # add one pixel margin
    image = create_image_with_volume_extent(
        sim, iec.name, spacing=[spacing, spacing, spacing], margin=1
    )
    info = get_info_from_image(image)
    print(f"Image : {info.size} {info.spacing} {info.origin}")

    # voxelized a volume
    print("Starting voxelization ...")
    se = SimulationEngine(sim)
    labels, image = voxelize_volume(se, image)
    print(f"Output labels: ")
    print_dic(labels)

    # write labels
    lf = output.replace(".mhd", ".json")
    outfile = open(lf, "w")
    json.dump(labels, outfile, indent=4)

    # write image
    print(f"Write image {output}")
    itk.imwrite(image, output)

    # voxelized source ?
    spheres_diam = [10, 13, 17, 22, 28, 37]
    spheres_activity_concentration = [6, 5, 4, 3, 2, 1]
    arr = image.get_array_view()
    for l in labels:
        if l.startswith("iec_sphere_") and "shell" not in l:
            sph = int(l.split("_")[2][:2])
            index = spheres_diam.index(sph)
            print(f"Sphere {sph}mm : {spheres_activity_concentration[index]}")

        else:
            print(f"Unknown label {l}")


# --------------------------------------------------------------------------
if __name__ == "__main__":
    go()
